-- === MM2 HUB - SIMPLIFIED WORKING VERSION ===
-- Murder Mystery 2 Script with Essential Features
-- Press RightShift to open/close

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Find MainEvent for kills
local MainEvent = ReplicatedStorage:FindFirstChild("MainEvent") or ReplicatedStorage:WaitForChild("MainEvent")

-- Create Main GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MM2Hub"
ScreenGui.Parent = game:GetService("CoreGui")
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

-- Main Frame
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 300, 0, 250)
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -125)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

-- Rounded corners
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 8)
TitleCorner.Parent = TitleBar

local TitleText = Instance.new("TextLabel")
TitleText.Name = "TitleText"
TitleText.Size = UDim2.new(1, -60, 1, 0)
TitleText.Position = UDim2.new(0, 10, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "MM2 HUB - ESSENTIAL"
TitleText.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Font = Enum.Font.GothamBold
TitleText.TextSize = 14
TitleText.Parent = TitleBar

-- Close Button
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 30, 1, 0)
CloseButton.Position = UDim2.new(1, -30, 0, 0)
CloseButton.BackgroundTransparency = 1
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 100, 100)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 16
CloseButton.Parent = TitleBar
CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- Content Frame
local ContentFrame = Instance.new("Frame")
ContentFrame.Name = "ContentFrame"
ContentFrame.Size = UDim2.new(1, -20, 1, -40)
ContentFrame.Position = UDim2.new(0, 10, 0, 35)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = MainFrame

-- Global Variables
_G.AutoCollect = false
_G.ESPEnabled = false
_G.AutoAim = false
_G.AutoMurderer = false
_G.AutoSheriff = false

-- Function to Create Toggle
local function CreateToggle(yPos, text, default, callback)
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Name = text .. "Toggle"
    ToggleFrame.Size = UDim2.new(1, 0, 0, 30)
    ToggleFrame.Position = UDim2.new(0, 0, 0, yPos)
    ToggleFrame.BackgroundTransparency = 1
    ToggleFrame.Parent = ContentFrame
    
    local ToggleText = Instance.new("TextLabel")
    ToggleText.Name = "ToggleText"
    ToggleText.Size = UDim2.new(0.7, -10, 1, 0)
    ToggleText.Position = UDim2.new(0, 10, 0, 0)
    ToggleText.BackgroundTransparency = 1
    ToggleText.Text = text
    ToggleText.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleText.TextXAlignment = Enum.TextXAlignment.Left
    ToggleText.Font = Enum.Font.Gotham
    ToggleText.TextSize = 13
    ToggleText.Parent = ToggleFrame
    
    local ToggleBtn = Instance.new("TextButton")
    ToggleBtn.Name = "ToggleBtn"
    ToggleBtn.Size = UDim2.new(0, 50, 0, 22)
    ToggleBtn.Position = UDim2.new(1, -60, 0.5, -11)
    ToggleBtn.BackgroundColor3 = default and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(80, 80, 90)
    ToggleBtn.Text = default and "ON" or "OFF"
    ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleBtn.Font = Enum.Font.GothamBold
    ToggleBtn.TextSize = 11
    ToggleBtn.Parent = ToggleFrame
    
    local BtnCorner = Instance.new("UICorner")
    BtnCorner.CornerRadius = UDim.new(0, 4)
    BtnCorner.Parent = ToggleBtn
    
    local state = default
    
    ToggleBtn.MouseButton1Click:Connect(function()
        state = not state
        ToggleBtn.BackgroundColor3 = state and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(80, 80, 90)
        ToggleBtn.Text = state and "ON" or "OFF"
        if callback then callback(state) end
    end)
end

-- Create Toggles
CreateToggle(0, "Auto Collect Coins", false, function(state)
    _G.AutoCollect = state
    if state then
        spawn(function()
            while _G.AutoCollect do
                task.wait(0.3)
                pcall(function()
                    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                        -- Find nearest coin
                        local coins = workspace:FindFirstChild("Coins") or workspace:FindFirstChild("Coin") or workspace:FindFirstChild("DroppedCoins")
                        if coins then
                            local nearestCoin = nil
                            local nearestDist = math.huge
                            
                            for _, coin in pairs(coins:GetChildren()) do
                                if coin:IsA("BasePart") and coin:FindFirstChild("TouchInterest") then
                                    local dist = (LocalPlayer.Character.HumanoidRootPart.Position - coin.Position).Magnitude
                                    if dist < nearestDist then
                                        nearestDist = dist
                                        nearestCoin = coin
                                    end
                                end
                            end
            
                            if nearestCoin then
                                LocalPlayer.Character.HumanoidRootPart.CFrame = nearestCoin.CFrame * CFrame.new(0, 2, 0)
                                task.wait(0.1)
                            end
                        end
                    end
                end)
            end
        end)
    end
end)

CreateToggle(35, "ESP (Player Highlight)", false, function(state)
    _G.ESPEnabled = state
    
    if state then
        spawn(function()
            while _G.ESPEnabled do
                task.wait(0.3)
                pcall(function()
                    for _, player in pairs(Players:GetPlayers()) do
                        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Humanoid") then
                            -- Create or update highlight
                            local highlight = player.Character:FindFirstChild("ESP_Highlight")
                            if not highlight then
                                highlight = Instance.new("Highlight")
                                highlight.Name = "ESP_Highlight"
                                highlight.FillTransparency = 0.5
                                highlight.OutlineTransparency = 1
                                highlight.Parent = player.Character
                            end
            
                            -- Color based on role
                            if player.Character:FindFirstChild("Knife") or player.Backpack:FindFirstChild("Knife") then
                                highlight.FillColor = Color3.fromRGB(255, 0, 0) -- RED = Murderer
                            elseif player.Character:FindFirstChild("Gun") or player.Backpack:FindFirstChild("Gun") then
                                highlight.FillColor = Color3.fromRGB(0, 100, 255) -- BLUE = Sheriff
                            else
                                highlight.FillColor = Color3.fromRGB(0, 255, 0) -- GREEN = Innocent
                            end
                        end
                    end
                end)
            end
            
            -- Remove highlights when disabled
            for _, player in pairs(Players:GetPlayers()) do
                pcall(function()
                    if player.Character and player.Character:FindFirstChild("ESP_Highlight") then
                        player.Character.ESP_Highlight:Destroy()
                    end
                end)
            end
        end)
    else
        for _, player in pairs(Players:GetPlayers()) do
            pcall(function()
                if player.Character and player.Character:FindFirstChild("ESP_Highlight") then
                    player.Character.ESP_Highlight:Destroy()
                end
            end)
        end
    end
end)

CreateToggle(70, "Auto Aim (Sheriff)", false, function(state)
    _G.AutoAim = state
end)

CreateToggle(105, "Auto Murderer Kill", false, function(state)
    _G.AutoMurderer = state
    if state then
        spawn(function()
            while _G.AutoMurderer do
                task.wait(0.3)
                pcall(function()
                    if (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Knife")) or (LocalPlayer.Backpack and LocalPlayer.Backpack:FindFirstChild("Knife")) then
                        -- Find nearest player
                        local nearestPlayer = nil
                        local nearestDist = math.huge
                        
                        for _, player in pairs(Players:GetPlayers()) do
                            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character.Humanoid.Health > 0 then
                                local dist = (LocalPlayer.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
                                if dist < 30 and dist < nearestDist then
                                    nearestDist = dist
                                    nearestPlayer = player
                                end
                            end
                        end
                        
                        if nearestPlayer and MainEvent then
                            MainEvent:FireServer("Knife", "Humanoid")
                        end
                    end
                end)
            end
        end)
    end
end)

CreateToggle(140, "Auto Sheriff Kill", false, function(state)
    _G.AutoSheriff = state
    if state then
        spawn(function()
            while _G.AutoSheriff do
                task.wait(0.3)
                pcall(function()
                    if (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Gun")) or (LocalPlayer.Backpack and LocalPlayer.Backpack:FindFirstChild("Gun")) then
                        -- Find nearest player
                        local nearestPlayer = nil
                        local nearestDist = math.huge
                        
                        for _, player in pairs(Players:GetPlayers()) do
                            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character.Humanoid.Health > 0 then
                                local dist = (LocalPlayer.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
                                if dist < 100 and dist < nearestDist then
                                    nearestDist = dist
                                    nearestPlayer = player
                                end
                            end
                        end
                        
                        if nearestPlayer and MainEvent then
                            MainEvent:FireServer("Gun", "Humanoid")
                        end
                    end
                end)
            end
        end)
    end
end)

-- Status Label at bottom
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Name = "StatusLabel"
StatusLabel.Size = UDim2.new(1, -20, 0, 25)
StatusLabel.Position = UDim2.new(0, 10, 1, -30)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Press RightShift to toggle | Role: ?"
StatusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
StatusLabel.TextXAlignment = Enum.TextXAlignment.Center
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 10
StatusLabel.Parent = MainFrame

-- Aimbot for Sheriff
RunService.RenderStepped:Connect(function()
    if _G.AutoAim and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        -- Check if player has gun (sheriff)
        if LocalPlayer.Character:FindFirstChild("Gun") or LocalPlayer.Backpack:FindFirstChild("Gun") then
            pcall(function()
                local target = nil
                local closestDist = math.huge
                
                for _, player in pairs(Players:GetPlayers()) do
                    if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character.Humanoid.Health > 0 then
                        -- Check if player is murderer (red highlight) or any player
                        if player.Character:FindFirstChild("Knife") or player.Backpack:FindFirstChild("Knife") then
                            local dist = (LocalPlayer.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
                            if dist < 100 and dist < closestDist then
                                closestDist = dist
                                target = player
                            end
                        end
                    end
                end
                
                if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                    Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Character.HumanoidRootPart.Position)
                end
            end)
        end
    end
end)

-- Update role in status bar
task.spawn(function()
    while task.wait(1) do
        pcall(function()
            if LocalPlayer.Character then
                if LocalPlayer.Character:FindFirstChild("Knife") or LocalPlayer.Backpack:FindFirstChild("Knife") then
                    StatusLabel.Text = "Press RightShift to toggle | Role: MURDERER (RED)"
                    StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
                elseif LocalPlayer.Character:FindFirstChild("Gun") or LocalPlayer.Backpack:FindFirstChild("Gun") then
                    StatusLabel.Text = "Press RightShift to toggle | Role: SHERIFF (BLUE)"
                    StatusLabel.TextColor3 = Color3.fromRGB(100, 100, 255)
                else
                    StatusLabel.Text = "Press RightShift to toggle | Role: INNOCENT (GREEN)"
                    StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
                end
            end
        end)
    end
end)

-- Toggle UI with RightShift
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.RightShift then
        MainFrame.Visible = not MainFrame.Visible
    end
end)

-- Anti-AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    VirtualUser:Button2Up(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
end)

-- Success Notification
task.wait(1)
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "MM2 HUB",
    Text = "Loaded! Press RightShift",
    Duration = 3
})
